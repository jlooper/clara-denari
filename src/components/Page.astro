---
import { translations } from '../i18n/translations.js';

export interface Props {
  url?: string;
  instructions?: string;
  action?: string;
  actionKey?: string;
  condition?: string;
  resultText?: string;
  showResultOnly?: boolean;
}

const { url, instructions = "", action = "", actionKey = "", condition = "none", resultText = "", showResultOnly = false } = Astro.props;

// Get localized action text
function getLocalizedAction() {
  if (actionKey) {
    // Use translation key if provided
    const currentLang = 'en'; // Default to English for server-side rendering
    const fallbackLang = 'en'; // Always use English for server-side rendering
    const translation = translations[actionKey];
    if (translation && translation[fallbackLang]) {
      return translation[fallbackLang];
    }
    if (translation && translation['en']) {
      return translation['en'];
    }
  }
  return action; // Fallback to hardcoded action
}

const localizedAction = getLocalizedAction();
---

<div class="page-navigation">
  {instructions && <p class="mb-4 text-gray-100">{instructions}</p>}
  
  <button 
    class="bg-black text-green-500 border-2 border-blue-500 px-6 py-3 rounded-lg hover:bg-green-500 hover:text-black transition-colors duration-200 font-bold text-lg"
    style="text-shadow: 0 0 5px rgba(244, 227, 153, 0.242);"
    data-url={url}
    data-condition={condition}
    data-result-text={resultText}
    data-show-result-only={showResultOnly}
    data-action-key={actionKey}
    id={`page-btn-${url || 'result'}`}
  >
    {localizedAction}
  </button>
</div>

<script>
  // Import translations for global access
  import { translations } from '../i18n/translations.js';
  
  // Make translations available globally
  if (typeof window !== 'undefined') {
    (window as any).translations = translations;
  }
  
  console.log('Page component script loaded');
  console.log('Page component translations available:', !!translations);
  
  // Check if DOM is already loaded
  function initializePageButtons() {
    console.log('Page component: Initializing buttons');
    // Find all page navigation buttons
    const pageButtons = document.querySelectorAll('[data-url], [data-show-result-only]');
    console.log('Page component: Found page buttons:', pageButtons.length);
    
    // Debug: Check for action key buttons
    const actionKeyButtons = document.querySelectorAll('[data-action-key]');
    console.log('Page component: Found action key buttons:', actionKeyButtons.length);
    actionKeyButtons.forEach((btn, index) => {
      console.log(`Action key button ${index}:`, btn.getAttribute('data-action-key'), btn.textContent);
    });
    
    // Check button visibility based on conditions
    pageButtons.forEach(button => {
      const condition = button.getAttribute('data-condition');
      
      // Check if button should be initially visible
      if (condition && condition !== 'none') {
        let shouldShow = true;
        
        // Check lab completion condition
        if (condition.startsWith('lab_')) {
          const labName = condition.replace('lab_', 'Lab ');
          const results = JSON.parse(localStorage.getItem('labResults') || '[]');
          shouldShow = results.some((result) => result.lab === labName && result.correct === true);
        }
        // Check item collection condition
        else if (!isNaN(Number(condition))) {
          const itemId = condition;
          const inventoryItems = JSON.parse(localStorage.getItem('inventory_item') || '{}');
          shouldShow = inventoryItems[itemId] === true;
        }
        
        // Hide button if condition not met
        if (!shouldShow) {
          (button as HTMLElement).style.display = 'none';
        }
      }
    });
    
    // Listen for inventory changes to update button visibility
    window.addEventListener('item_added', () => {
      pageButtons.forEach(button => {
        const condition = button.getAttribute('data-condition');
        
        if (condition && condition !== 'none') {
          let shouldShow = true;
          
          // Check item collection condition
          if (!isNaN(Number(condition))) {
            const itemId = condition;
            const inventoryItems = JSON.parse(localStorage.getItem('inventory_item') || '{}');
            shouldShow = inventoryItems[itemId] === true;
          }
          
          // Show/hide button based on condition
          (button as HTMLElement).style.display = shouldShow ? 'block' : 'none';
        }
      });
    });
    
    pageButtons.forEach(button => {
      button.addEventListener('click', () => {
        const url = button.getAttribute('data-url');
        const condition = button.getAttribute('data-condition');
        const resultText = button.getAttribute('data-result-text');
        const showResultOnly = button.getAttribute('data-show-result-only') === 'true';
        
        // If there's result text, show it in the notification panel
        if (resultText) {
          if (typeof window !== 'undefined' && (window as any).showNotificationPanel) {
            (window as any).showNotificationPanel(resultText, 4000);
          }
        }
        
        // If showResultOnly is true, don't navigate
        if (showResultOnly) {
          return;
        }
        
        // Check condition if specified
        if (condition && condition !== 'none') {
          // Check if this is a lab completion condition
          if (condition.startsWith('lab_')) {
            const labName = condition.replace('lab_', 'Lab ');
            const results = JSON.parse(localStorage.getItem('labResults') || '[]');
            const labCompleted = results.some((result) => result.lab === labName && result.correct === true);
            
            if (!labCompleted) {
              // Show notification that lab must be completed first
              if (typeof window !== 'undefined' && (window as any).showNotificationPanel) {
                (window as any).showNotificationPanel(`You must complete ${labName} first! Use the Lab button to take the quiz.`, 5000);
              }
              return; // Don't navigate
            }
          } 
          // Check if this is an item collection condition (numeric)
          else if (!isNaN(Number(condition))) {
            const itemId = condition;
            const inventoryItems = JSON.parse(localStorage.getItem('inventory_item') || '{}');
            const itemCollected = inventoryItems[itemId] === true;
            
            if (!itemCollected) {
              // Show notification that item must be collected first
              if (typeof window !== 'undefined' && (window as any).showNotificationPanel) {
                (window as any).showNotificationPanel(`You need to examine the evidence first! Look for items you can interact with.`, 5000);
              }
              return; // Don't navigate
            }
          }
        }
        
        // Navigate to the page if URL is provided
        if (url) {
          window.location.href = `/${url}`;
        }
      });
    });
  }

  // Listen for language changes and update button text
  function handleLanguageChange() {
    console.log('Page component: Language changed event received');
    const pageButtons = document.querySelectorAll('[data-action-key]');
    console.log('Page component: Found buttons with action keys:', pageButtons.length);
    
    // Debug: Let's see what buttons exist
    const allButtons = document.querySelectorAll('button');
    console.log('Page component: Total buttons found:', allButtons.length);
    allButtons.forEach((btn, index) => {
      console.log(`Button ${index}:`, btn.getAttribute('data-action-key'), btn.textContent);
    });
    
    pageButtons.forEach(button => {
      const actionKey = button.getAttribute('data-action-key');
      console.log('Page component: Processing button with actionKey:', actionKey);
      if (actionKey) {
        const currentLang = localStorage.getItem('preferred-language') || 'en';
        const fallbackLang = (currentLang === 'pt-br') ? 'en' : currentLang;
        const globalTranslations = (window as any).translations || translations;
        const translation = globalTranslations[actionKey];
        console.log('Page component: Current lang:', currentLang, 'Fallback lang:', fallbackLang);
        console.log('Page component: Translation found:', !!translation);
        
        if (translation && translation[fallbackLang]) {
          console.log('Page component: Updating button text to:', translation[fallbackLang]);
          button.textContent = translation[fallbackLang];
        } else if (translation && translation['en']) {
          console.log('Page component: Updating button text to English:', translation['en']);
          button.textContent = translation['en'];
        } else {
          console.log('Page component: No translation found for actionKey:', actionKey);
        }
      }
    });
  }

  // Add event listeners for language changes
  document.addEventListener('language-changed', handleLanguageChange);
  window.addEventListener('language-changed', handleLanguageChange);

  // Add event listener when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    initializePageButtons();
  });

  // If DOM is already loaded, initialize immediately
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePageButtons);
  } else {
    initializePageButtons();
  }

  console.log('Page component: Language change listener attached');
  
  // Test the event listener
  setTimeout(() => {
    console.log('Page component: Testing language change event...');
    window.dispatchEvent(new CustomEvent('language-changed', { 
      detail: { language: 'test' } 
    }));
  }, 1000);
</script> 